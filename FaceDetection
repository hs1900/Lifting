%Face Detection to find location of template
clear;clc;close all;

vidObj = VideoReader('badformshade.m4v'); 
numFrames = vidObj.NumberOfFrames;
vidHeight = vidObj.Height; 
vidWidth = vidObj.Width;

%Assuming the person will need to face the camera to turn off the recording
%so only the last x% of the entire segment is processed
cutoff = floor(numFrames*(2/3));
num2Process = numFrames-cutoff;

Obj = VideoWriter('FaceDetection.avi');
faceDetector = vision.CascadeObjectDetector('MinSize',[20 20]);

%bbox [x y xdistance ydistance]

minBox = vidHeight/2;

open(Obj);
for i=1:num2Process    
    Frame = read(vidObj,i+cutoff-1);
    
    % Read a video frame and run the detector.
    bbox = step(faceDetector, Frame);
    
    % Draw the returned bounding box around the detected face.
    videoOut = insertShape(Frame,'rectangle',bbox,'Color','green');
    
     if min(bbox(:,2)) < minBox
        minBox = min(bbox(:,2));
        templateFrameNum = i;
        templateLocation = bbox;
     end
    
    writeVideo(Obj,videoOut);
end

close(Obj);

%%
%Template Matching

x1 = templateLocation(1); y1 = templateLocation(2);
x2 = templateLocation(3) + x1; y2 = templateLocation(4) + y1;
templateFrame = rgb2gray(read(vidObj,templateFrameNum+cutoff));
initialTemplate = templateFrame(y1:y2,x1:x2);

Frame2 = rgb2gray(read(vidObj,templateFrameNum-1+cutoff));

[dx dy matchblock] = templatematching(initialTemplate,Frame2,x1,y1,20);
dx
dy
imshow(uint8(matchblock))
